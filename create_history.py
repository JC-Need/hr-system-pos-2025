import os
import django
import random
from datetime import date, timedelta, time, datetime

# 1. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Environment
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'mycompany.settings')
django.setup()

from employees.models import Employee, Attendance, LeaveRequest

# ==========================================
# ‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏à‡∏≥‡∏•‡∏≠‡∏á
# ==========================================
DAYS_BACK = 30  # ‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á 30 ‡∏ß‡∏±‡∏ô
today = date.today()
employees = Employee.objects.all()

print(f"üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏≥‡∏•‡∏≠‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á {DAYS_BACK} ‡∏ß‡∏±‡∏ô ‡πÉ‡∏´‡πâ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô {employees.count()} ‡∏Ñ‡∏ô...")
print("---------------------------------------------------")

# ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏∏‡πà‡∏°‡πÄ‡∏ß‡∏•‡∏≤ (‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á, ‡∏ô‡∏≤‡∏ó‡∏µ)
def random_time(start_h, end_h, start_m=0, end_m=59):
    h = random.randint(start_h, end_h)
    m = random.randint(start_m, end_m)
    return time(h, m, 0)

# 2. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏µ‡∏•‡∏∞‡∏ß‡∏±‡∏ô
for i in range(DAYS_BACK):
    # ‡πÑ‡∏•‡πà‡∏à‡∏≤‡∏Å‡∏≠‡∏î‡∏µ‡∏ï‡∏°‡∏≤‡∏´‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (30 ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß -> ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)
    # ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡πÑ‡∏•‡πà‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏¢‡πâ‡∏≠‡∏ô‡πÑ‡∏õ ‡πÉ‡∏´‡πâ‡πÅ‡∏Å‡πâ logic ‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢ ‡πÅ‡∏ï‡πà‡∏≠‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ß‡∏ô‡πÅ‡∏ö‡∏ö‡πÑ‡∏´‡∏ô‡∏Å‡πá‡πÑ‡∏î‡πâ‡∏ú‡∏•‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô
    current_date = today - timedelta(days=i)
    
    # ‚ùå ‡∏Ç‡πâ‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡πÄ‡∏™‡∏≤‡∏£‡πå-‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô)
    if current_date.weekday() >= 5: # 5=Sat, 6=Sun
        continue

    print(f"üìÖ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: {current_date.strftime('%d/%m/%Y')} ...")

    for emp in employees:
        # üé≤ ‡∏ó‡∏≠‡∏¢‡∏•‡∏π‡∏Å‡πÄ‡∏ï‡πã‡∏≤‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏î‡∏ß‡∏á (0-100)
        chance = random.randint(0, 100)

        # --- ‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà 1: ‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢ / ‡∏•‡∏≤‡∏Å‡∏¥‡∏à (‡πÇ‡∏≠‡∏Å‡∏≤‡∏™ 5%) ---
        if chance < 5:
            leave_type = random.choice(['SICK', 'BUSINESS'])
            reason = "‡∏õ‡∏ß‡∏î‡∏´‡∏±‡∏ß‡∏ï‡∏±‡∏ß‡∏£‡πâ‡∏≠‡∏ô" if leave_type == 'SICK' else "‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£"
            
            # ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏•‡∏≤ + ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏•‡∏¢ (‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏Ç‡∏∂‡πâ‡∏ô‡πÉ‡∏ô‡∏Å‡∏£‡∏≤‡∏ü)
            LeaveRequest.objects.get_or_create(
                employee=emp,
                start_date=current_date,
                end_date=current_date, # ‡∏•‡∏≤‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
                defaults={
                    'leave_type': leave_type,
                    'reason': f"‡∏à‡∏≥‡∏•‡∏≠‡∏á: {reason}",
                    'status': 'APPROVED' # ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                }
            )
            # ‡∏ñ‡πâ‡∏≤‡∏•‡∏≤‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡πá‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≠‡∏Å‡∏ö‡∏±‡∏ï‡∏£
            continue

        # --- ‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà 2: ‡∏Ç‡∏≤‡∏î‡∏á‡∏≤‡∏ô‡∏î‡∏∑‡πâ‡∏≠‡πÜ (‡πÇ‡∏≠‡∏Å‡∏≤‡∏™ 3%) ---
        elif chance < 8:
            # ‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£‡πÄ‡∏•‡∏¢ = ‡πÑ‡∏°‡πà‡∏°‡∏µ Record = ‡∏Ç‡∏≤‡∏î‡∏á‡∏≤‡∏ô (Absent)
            continue

        # --- ‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà 3: ‡∏°‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (‡πÇ‡∏≠‡∏Å‡∏≤‡∏™ 92%) ---
        else:
            # ‡∏™‡∏∏‡πà‡∏°‡∏ß‡πà‡∏≤‡∏à‡∏∞ "‡∏°‡∏≤‡∏™‡∏≤‡∏¢" ‡∏´‡∏£‡∏∑‡∏≠ "‡∏õ‡∏Å‡∏ï‡∏¥"
            is_late = True if random.randint(0, 100) < 15 else False # ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏™‡∏≤‡∏¢ 15%

            if is_late:
                # ‡∏™‡∏≤‡∏¢: ‡πÄ‡∏Ç‡πâ‡∏≤ 09:01 - 10:30
                t_in = random_time(9, 10, 1, 30)
            else:
                # ‡∏õ‡∏Å‡∏ï‡∏¥: ‡πÄ‡∏Ç‡πâ‡∏≤ 07:30 - 08:50
                t_in = random_time(7, 8, 30, 50)
            
            # ‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å: 17:00 - 19:30
            t_out = random_time(17, 19, 0, 30)

            # ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÉ‡∏ä‡πâ update_or_create ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ô‡∏ã‡πâ‡∏≥‡∏à‡∏∞‡πÑ‡∏î‡πâ‡πÑ‡∏°‡πà‡πÄ‡∏ö‡∏¥‡πâ‡∏•)
            Attendance.objects.update_or_create(
                employee=emp,
                date=current_date,
                defaults={
                    'time_in': t_in,
                    'time_out': t_out
                }
            )

print("\nüéâ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå! ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ô‡πà‡∏ô‡∏õ‡∏∂‡πâ‡∏Å‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÇ‡∏ä‡∏ß‡πå‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö JC!")
{% load humanize %}
{% load static %}

<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ใบเสนอราคา {{ qt.quotation_no }}</title>

    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

    <style>
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #5a5c69;
            padding: 20px 0;
            color: #333;
        }

        .page-a4 {
            width: 210mm;
            min-height: 297mm;
            background: white;
            margin: 0 auto;
            /* Padding ด้านล่าง 40mm เพื่อกันพื้นที่ให้ Footer */
            padding: 15mm 15mm 40mm 15mm;
            position: relative;
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
            box-sizing: border-box;
            /* Flexbox แนวตั้ง */
            display: flex;
            flex-direction: column;
        }

        /* เส้นตารางสีเขียว (ส่วนหัวตาราง) */
        .table-custom th {
            border-top: 2px solid #1cc88a !important;
            border-bottom: 2px solid #1cc88a !important;
            background-color: #fff;
            color: #000;
            font-weight: 600;
        }

        /* ✅ แก้ไข: ลบเส้นขีดคั่นบรรทัดสินค้าออก (border-bottom: none) */
        .table-custom td {
            border-bottom: none !important;
            vertical-align: top;
            padding: 10px 8px;
        }

        .no-wrap { white-space: nowrap; }

        @media print {
            @page { size: A4; margin: 0; }
            body { background: white; padding: 0; }
            .page-a4 {
                width: 100%; margin: 0;
                padding: 15mm 15mm 40mm 15mm;
                box-shadow: none; border: none; min-height: 297mm;
            }
            .d-print-none { display: none !important; }
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
        }
    </style>
</head>
<body>

    <div class="container mb-3 d-print-none text-right" style="width: 210mm;">

        <a href="{% url 'quotation_list' %}" class="btn btn-secondary shadow-sm mr-2">
            <i class="fas fa-chevron-left mr-1"></i> กลับหน้ารายการ
        </a>

        <a href="{% url 'quotation_edit' qt.id %}" class="btn btn-light text-dark shadow-sm border">
            <i class="fas fa-pen mr-1"></i> กลับไปแก้ไข
        </a>

        <button onclick="window.print()" class="btn btn-primary shadow-sm ml-2">
            <i class="fas fa-print mr-1"></i> พิมพ์ใบเสนอราคา
        </button>
    </div>

    <div class="page-a4">

        <div class="row mb-2">
            <div class="col-7">
                <div class="d-flex align-items-center mb-1">
                    <div class="mr-3">
                        {% if company.logo %}
                            <img src="{{ company.logo.url }}" alt="Logo" style="height: 60px; width: auto; object-fit: contain;">
                        {% else %}
                            <div style="width: 50px; height: 50px; background-color: #1cc88a; color: white; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 24px;">
                                <i class="fas fa-cube"></i>
                            </div>
                        {% endif %}
                    </div>
                    <div>
                        <h3 class="font-weight-bold m-0" style="color: #1cc88a; line-height: 1.2;">
                            {{ company.name_th|default:"บริษัท นีด ช็อปปิ้ง จำกัด" }}
                        </h3>
                        <div class="small text-secondary text-uppercase" style="letter-spacing: 1px;">
                            {{ company.name_en|default:"Need Shopping Co., Ltd." }}
                        </div>
                    </div>
                </div>

                <div class="small text-secondary" style="line-height: 1.5;">
                    {{ company.address|default:"10/10 หมู่ 10 ตำบลบางพระ อำเภอศรีราชา จังหวัดชลบุรี 20110" }}<br>
                    โทร: {{ company.phone|default:"033 166 699" }} |
                    Tax ID: {{ company.tax_id|default:"0205563029342" }}<br>
                    Email: {{ company.email|default:"needshopping.acc@gmail.com" }}
                </div>
            </div>

            <div class="col-5 text-right">
                <h1 class="font-weight-bold text-dark mb-0" style="font-size: 2.5rem;">ใบเสนอราคา</h1>

                <table class="table table-borderless table-sm mt-4 small text-right float-right" style="width: 100%;">
                    <tr>
                        <td class="text-muted p-0">เลขที่ (No.):</td>
                        <td class="font-weight-bold p-0" style="color: #000000 !important; font-size: 1.1em;">
                            {{ qt.qt_number }}
                        </td>
                    </tr>
                    <tr>
                        <td class="text-muted p-0">วันที่ (Date):</td>
                        <td class="font-weight-bold p-0 text-dark">{{ qt.date|date:"d/m/Y" }}</td>
                    </tr>
                    <tr>
                        <td class="text-muted p-0">ยืนยันราคาถึง:</td>
                        <td class="font-weight-bold p-0 text-dark">
                            {% if qt.valid_until %}{{ qt.valid_until|date:"d/m/Y" }}{% else %}-{% endif %}
                        </td>
                    </tr>
                </table>
            </div>
        </div>

        <div class="p-3 mb-3" style="background-color: #f8f9fc; border-radius: 6px; border-left: 5px solid #1cc88a;">
            <div class="row">
                <div class="col-8">
                    <strong class="text-dark" style="font-size: 1.1em;">ชื่อลูกค้า: {{ qt.customer_name }}</strong><br>

                    <div class="text-muted small mt-1">
                        {{ qt.customer_address }}
                        {% if qt.customer_sub_district and qt.customer_sub_district != 'None' %}{{ qt.customer_sub_district }}{% endif %}
                        {% if qt.customer_district and qt.customer_district != 'None' %}{{ qt.customer_district }}{% endif %}
                        {% if qt.customer_province and qt.customer_province != 'None' %}{{ qt.customer_province }}{% endif %}
                        {% if qt.customer_zip and qt.customer_zip != 'None' %}{{ qt.customer_zip }}{% endif %}

                        {% if qt.customer_phone %}
                            <br><strong class="text-dark">โทร: {{ qt.customer_phone }}</strong>
                        {% endif %}
                    </div>
                </div>

                <div class="col-4 text-right">
                    <small class="text-muted">รหัสลูกค้า</small><br>
                    <strong class="d-block mb-2 text-primary small">
                        {{ customer_obj.code|default:"-" }}
                    </strong>

                    <small class="text-muted">เลขผู้เสียภาษี</small><br>
                    <strong>{{ qt.customer_tax_id|default:"-" }}</strong>
                </div>
            </div>
        </div>

        <table class="table table-custom mb-3 w-100">
            <thead>
                <tr>
                    <th style="width: 8%;" class="text-center">ลำดับ</th>
                    <th style="width: 50%;">รายการสินค้า (Description)</th>
                    <th style="width: 10%;" class="text-center">จำนวน</th>
                    <th style="width: 16%;" class="text-right">ราคา/หน่วย</th>
                    <th style="width: 16%;" class="text-right">รวมเงิน</th>
                </tr>
            </thead>
            <tbody>
                {% for item in qt.items.all %}
                <tr>
                    <td class="text-center">{{ forloop.counter }}</td>
                    <td>{{ item.product.name }}</td>
                    <td class="text-center">{{ item.quantity }}</td>
                    <td class="text-right">{{ item.unit_price|intcomma }}</td>
                    <td class="text-right font-weight-bold no-wrap">
                        {{ item.total_price|intcomma }} <span class="text-muted small font-weight-normal">บาท</span>
                    </td>
                </tr>
                {% endfor %}

                {% if qt.items.count < 5 %}
                    {% for i in "123"|make_list %}
                    <tr><td class="py-4">&nbsp;</td><td></td><td></td><td></td><td></td></tr>
                    {% endfor %}
                {% endif %}
            </tbody>
        </table>

        <div class="row mt-1 align-items-start">

            <div class="col-6">
                <div class="pr-3">
                    <div class="mb-3 p-2 pl-3" style="background-color: #f1fcf6; border-radius: 6px; border-left: 4px solid #28a745;">
                        <h6 class="font-weight-bold text-success mb-1" style="font-size: 0.8rem;">
                            <i class="fas fa-university mr-1"></i> ข้อมูลการชำระเงิน (Payment Details)
                        </h6>
                        <div class="small text-dark" style="line-height: 1.5;">
                            ธนาคาร: <strong>กสิกรไทย (KBANK)</strong><br>
                            ชื่อบัญชี: <strong>บริษัท นีด ช็อปปิ้ง จำกัด</strong><br>
                            เลขบัญชี: <strong style="font-size: 0.9rem;">075-3-824782</strong>
                        </div>
                    </div>

                    <strong class="text-dark">เงื่อนไข / หมายเหตุ:</strong>
                    <div class="mt-1 text-secondary small" style="line-height: 1.6;">
                        {% if qt.note %}
                            {{ qt.note|linebreaks }}
                        {% else %}
                            - กรุณาชำระเงินมัดจำ 50% ของยอดรวม เพื่อยืนยันการสั่งซื้อ <br>
                            - ชำระเงินส่วนที่เหลือทั้งหมด ก่อนการจัดส่งสินค้า
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="col-6">
                <table class="table table-borderless table-sm m-0">
                    <tr>
                        <td class="text-right text-muted" style="white-space: nowrap;">รวมราคาสินค้า</td>
                        <td class="text-right text-dark no-wrap">{{ item_total|intcomma }} บาท</td>
                    </tr>

                    {% if qt.shipping_cost > 0 %}
                    <tr>
                        <td class="text-right text-primary">ค่าขนส่ง</td>
                        <td class="text-right text-primary no-wrap">{{ qt.shipping_cost|intcomma }} บาท</td>
                    </tr>
                    {% endif %}

                    {% if qt.discount > 0 %}
                    <tr>
                        <td class="text-right text-danger">หักส่วนลด</td>
                        <td class="text-right text-danger no-wrap">-{{ qt.discount|intcomma }} บาท</td>
                    </tr>
                    {% endif %}

                    <tr>
                        <td class="text-right text-muted" style="white-space: nowrap;">ราคาสินค้าก่อนภาษี</td>
                        <td class="text-right no-wrap">{{ qt.subtotal|intcomma }} บาท</td>
                    </tr>

                    <tr>
                        <td class="text-right text-muted">ภาษีมูลค่าเพิ่ม 7%</td>
                        <td class="text-right text-danger no-wrap">{{ qt.vat_amount|intcomma }} บาท</td>
                    </tr>

                    <tr style="border-top: 2px solid #1cc88a; border-bottom: 2px solid #1cc88a; background-color: #f8f9fc;">
                        <td class="text-right font-weight-bold text-success py-2 align-middle" style="white-space: nowrap;">จำนวนเงินรวมทั้งสิ้น</td>
                        <td class="text-right font-weight-bold text-success py-2 no-wrap" style="font-size: 1.3rem;">
                            {{ qt.grand_total|intcomma }} บาท
                        </td>
                    </tr>
                </table>
            </div>
        </div>

        <div class="row mt-auto" style="padding-top: 40px;">
            <div class="col-6 text-center">
                <div class="text-secondary" style="font-size: 0.7rem; line-height: 1.5; margin-bottom: 50px;">
                    ผู้ซื้อรับทราบเงื่อนไขการรับประกันของบริษัทฯ <br>
                    และลงชื่อเป็นลายลักษณ์อักษร
                </div>

                <div style="border-bottom: 1px dotted #ccc; width: 80%; margin: 0 auto;"></div>
                <div class="mt-2 font-weight-bold small text-dark">ผู้สั่งซื้อ (Buyer)</div>
                <div class="small text-muted mt-1">วันที่: ___/___/______</div>
            </div>

            <div class="col-6 text-center align-self-end">
                <div style="border-bottom: 1px dotted #ccc; width: 80%; margin: 0 auto;"></div>
                <div class="mt-2 font-weight-bold small text-dark">ผู้จัดการ (Authorized Signature)</div>
                <div class="small text-muted mt-1">บริษัท นีด ช็อปปิ้ง จำกัด</div>
            </div>
        </div>

        <div class="text-center text-muted small border-top"
             style="position: absolute; bottom: 25mm; left: 15mm; right: 15mm; padding-top: 10px; font-size: 0.7rem;">
            ขอบคุณที่ใช้บริการ (Thank you for your business)
        </div>

    </div>

</body>
</html>
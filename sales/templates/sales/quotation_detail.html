{% extends 'employees/base.html' %}
{% load humanize %}

{% block content %}
<div class="container mt-4 mb-5">
    <div class="d-flex justify-content-between mb-4 d-print-none">
        <a href="{% url 'quotation_list' %}" class="btn btn-secondary"><i class="fas fa-arrow-left"></i> กลับหน้ารายการ</a>
        <div>
            {% if qt.status == 'DRAFT' %}
                <form method="post" style="display:inline;">
                    {% csrf_token %}
                    <input type="hidden" name="save_qt" value="true">
                    <button type="submit" class="btn btn-success me-2"><i class="fas fa-calculator"></i> คำนวณยอดเงิน</button>
                </form>
            {% endif %}
            <button onclick="window.print()" class="btn btn-primary"><i class="fas fa-print"></i> พิมพ์เอกสาร (A4)</button>
        </div>
    </div>

    <div class="card shadow-sm p-5" style="min-height: 297mm; position: relative;">
        <div class="row mb-4">
            <div class="col-8">
                <h2 class="fw-bold text-primary"><i class="fas fa-building me-2"></i>บริษัท เจซี จำกัด</h2>
                <p class="mb-0 small">123 นิคมอุตสาหกรรมบางพลี ต.บางเสาธง จ.สมุทรปราการ 10540</p>
                <p class="small">โทร: 02-xxx-xxxx | Tax ID: 011555xxxxxxx</p>
            </div>
            <div class="col-4 text-end">
                <h3 class="fw-bold text-uppercase">ใบเสนอราคา</h3>
                <h5 class="text-muted">QUOTATION</h5>
            </div>
        </div>
        <hr>
        <div class="row mb-4">
            <div class="col-7">
                <h6 class="fw-bold text-muted small">ลูกค้า (CUSTOMER):</h6>
                <h5 class="fw-bold">{{ qt.customer_name }}</h5>
                <p class="mb-1 small">{{ qt.customer_address|linebreaksbr }}</p>
                <p class="small"><strong>เลขผู้เสียภาษี:</strong> {{ qt.customer_tax_id|default:"-" }}</p>
            </div>
            <div class="col-5">
                <table class="table table-bordered table-sm small mb-0">
                    <tr><th class="bg-light">เลขที่ (QT No.):</th><td class="fw-bold">{{ qt.qt_number }}</td></tr>
                    <tr><th class="bg-light">วันที่ (Date):</th><td>{{ qt.date|date:"d/m/Y" }}</td></tr>
                    <tr><th class="bg-light">พนักงานขาย:</th><td>{{ qt.sales_person.first_name }}</td></tr>
                </table>
            </div>
        </div>
        <table class="table table-striped table-bordered mb-4">
            <thead class="bg-primary text-white text-center">
                <tr>
                    <th style="width:5%">#</th>
                    <th style="width:50%">รายการสินค้า</th>
                    <th style="width:10%">จำนวน</th>
                    <th style="width:15%">ราคา/หน่วย</th>
                    <th style="width:20%">รวมเงิน</th>
                </tr>
            </thead>
            <tbody>
                {% for item in qt.items.all %}
                <tr>
                    <td class="text-center">{{ forloop.counter }}</td>
                    <td>{{ item.product.name }}</td>
                    <td class="text-center">{{ item.quantity }}</td>
                    <td class="text-end">{{ item.unit_price|intcomma }}</td>
                    <td class="text-end">{{ item.total_price|intcomma }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <div class="row">
            <div class="col-6 offset-6">
                <table class="table table-bordered table-sm">
                    <tr><td class="text-end fw-bold">รวมเป็นเงิน</td><td class="text-end">{{ qt.subtotal|intcomma }}</td></tr>
                    <tr><td class="text-end fw-bold">VAT 7%</td><td class="text-end">{{ qt.vat_amount|intcomma }}</td></tr>
                    <tr class="table-active"><td class="text-end fw-bold text-primary">ยอดสุทธิ</td><td class="text-end fw-bold fs-5">{{ qt.grand_total|intcomma }}</td></tr>
                </table>
            </div>
        </div>
    </div>

    {% if qt.status == 'DRAFT' %}
    <div class="card mt-4 shadow-sm d-print-none bg-warning bg-opacity-10 border-warning">
        <div class="card-body">
            <h5 class="fw-bold">เพิ่มสินค้า</h5>
            <form method="post" class="row g-2 align-items-end">
                {% csrf_token %}
                <div class="col-md-5">
                    <label class="small">เลือกสินค้า</label>
                    <select name="product" class="form-select">
                        {% for p in products %}<option value="{{ p.id }}">{{ p.name }} (Stock: {{ p.stock }})</option>{% endfor %}
                    </select>
                </div>
                <div class="col-md-2"><label class="small">ราคา</label><input type="number" name="price" class="form-control" step="0.01" required></div>
                <div class="col-md-2"><label class="small">จำนวน</label><input type="number" name="quantity" class="form-control" value="1" required></div>
                <div class="col-md-3"><button type="submit" name="add_item" class="btn btn-dark w-100">เพิ่มรายการ</button></div>
            </form>
        </div>
    </div>
    {% endif %}
</div>
<style> @media print { body * { visibility: hidden; } .card, .card * { visibility: visible; } .card { position: absolute; left: 0; top: 0; width: 100%; border: none !important; } .d-print-none { display: none !important; } } </style>
{% endblock %}
{% extends 'employees/base.html' %}
{% load humanize %} 

{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<style>
    .flatpickr-input { background-color: #fff !important; cursor: pointer; }
    .btn-profile-link:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.2) !important; }
</style>

<div class="container-fluid mt-4 pb-5">
    
    {% if request.user.is_superuser or request.user.username == 'jcneed1975' %}
    <div class="row mb-4">
        <div class="col-12 text-center">
            <div class="card shadow-sm p-3 border-0 bg-light d-inline-block rounded-pill">
                <div class="btn-group" role="group">
                    
                    <a href="{% url 'dashboard' %}?view=all" class="btn rounded-pill px-4 fw-bold {% if not view_mode or view_mode == 'all' %}btn-dark{% else %}btn-outline-dark border-0{% endif %}">
                        <i class="fas fa-tachometer-alt me-2"></i> ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏° (CEO)
                    </a>

                    {% for dept in all_departments %}
                        <a href="{% url 'dashboard' %}?view={{ dept }}" class="btn rounded-pill px-4 fw-bold ms-1 
                           {% if view_mode == dept %}btn-primary shadow{% else %}btn-outline-secondary border-0{% endif %}">
                            <i class="fas fa-building me-1"></i> {{ dept }}
                        </a>
                    {% endfor %}
                    
                </div>
            </div>
            
            <div class="mt-2 text-muted small">
                <i class="fas fa-eye me-1"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•: <strong>{{ current_dept_view|default:"‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó" }}</strong>
            </div>
        </div>
    </div>
    {% endif %}

    {% if show_sales %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm bg-primary text-white overflow-hidden">
                <div class="card-body p-4 d-flex justify-content-between align-items-center position-relative">
                    <div style="z-index: 1;">
                        <h2 class="fw-bold mb-1">üè™ ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏≤‡∏¢‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô (POS)</h2>
                        <div class="mt-2">
                            {% if current_emp_id %}
                                <a href="{% url 'employee_detail' current_emp_id %}" class="btn btn-warning btn-sm text-dark fw-bold rounded-pill shadow-sm btn-profile-link border-2 border-white">
                                    <i class="fas fa-user-circle me-1"></i> {{ role_name }} (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß)
                                </a>
                            {% else %}
                                <span class="badge bg-warning text-dark">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: {{ role_name }}</span>
                            {% endif %}
                        </div>
                    </div>
                    <a href="{% url 'pos_home' %}" class="btn btn-light text-primary fw-bold px-4 py-2 rounded-pill shadow" style="z-index: 1;">
                        <i class="fas fa-play me-1"></i> ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ç‡∏≤‡∏¢‡πÄ‡∏•‡∏¢
                    </a>
                    <i class="fas fa-shopping-basket position-absolute text-white" style="font-size: 150px; opacity: 0.15; right: -20px; top: -30px;"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row g-2 align-items-center mb-3">
        <div class="col-12">
            <div class="card shadow-sm border-0 bg-light">
                <div class="card-body py-2">
                    <form method="get" class="row g-2 align-items-center">
                        <input type="hidden" name="view" value="{{ view_mode }}">
                        
                        <div class="col-auto"><span class="fw-bold text-success"><i class="fas fa-filter me-1"></i> ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏Ç‡∏≤‡∏¢:</span></div>
                        <div class="col-auto"><div class="input-group input-group-sm"><span class="input-group-text bg-white">‡πÄ‡∏£‡∏¥‡πà‡∏°</span><input type="text" name="sales_start" class="form-control datepicker text-center" value="{{ filter_start }}" autocomplete="off" placeholder="‡∏ß‡∏ß/‡∏î‡∏î/‡∏õ‡∏õ‡∏õ‡∏õ"></div></div>
                        <div class="col-auto"><div class="input-group input-group-sm"><span class="input-group-text bg-white">‡∏ñ‡∏∂‡∏á</span><input type="text" name="sales_end" class="form-control datepicker text-center" value="{{ filter_end }}" autocomplete="off" placeholder="‡∏ß‡∏ß/‡∏î‡∏î/‡∏õ‡∏õ‡∏õ‡∏õ"></div></div>
                        <div class="col-auto"><button type="submit" class="btn btn-primary btn-sm px-3 shadow-sm">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</button></div>

                        <div class="col-auto ps-3 border-start ms-2">
                            <a href="?view={{ view_mode }}&sales_start={{ today|date:'Y-m-d' }}&sales_end={{ today|date:'Y-m-d' }}" 
                               class="btn btn-outline-secondary btn-sm fw-bold shadow-sm" 
                               title="‡∏î‡∏π‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ">
                                <i class="fas fa-calendar-day text-primary"></i> ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
                            </a>

                            <a href="?view={{ view_mode }}&sales_start={{ today|date:'Y-m-01' }}&sales_end={{ today|date:'Y-m-t' }}" 
                               class="btn btn-outline-secondary btn-sm fw-bold shadow-sm" 
                               title="‡∏î‡∏π‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ">
                                <i class="fas fa-calendar-alt text-success"></i> ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-md-3"><div class="card bg-white border-start border-4 border-info shadow-sm h-100 py-2"><div class="card-body"><div class="text-xs font-weight-bold text-info text-uppercase mb-1">‡∏ö‡∏¥‡∏•‡∏Ç‡∏≤‡∏¢</div><div class="h3 mb-0 fw-bold text-gray-800">{{ period_orders_count }} ‡πÉ‡∏ö</div></div></div></div>
        <div class="col-md-3"><div class="card bg-white border-start border-4 border-primary shadow-sm h-100 py-2"><div class="card-body"><div class="text-xs font-weight-bold text-primary text-uppercase mb-1">‡∏ä‡∏¥‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢</div><div class="h3 mb-0 fw-bold text-gray-800">{{ period_items_sold }} ‡∏ä‡∏¥‡πâ‡∏ô</div></div></div></div>
        <div class="col-md-3"><div class="card bg-white border-start border-4 border-danger shadow-sm h-100 py-2"><div class="card-body"><div class="text-xs font-weight-bold text-danger text-uppercase mb-1">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î</div><div class="h3 mb-0 fw-bold text-gray-800">{{ low_stock_count }} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div></div></div></div>
        <div class="col-md-3"><div class="card bg-white border-start border-4 border-secondary shadow-sm h-100 py-2"><div class="card-body"><div class="text-xs font-weight-bold text-secondary text-uppercase mb-1">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div><div class="h3 mb-0 fw-bold text-gray-800">{{ total_products }} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div></div></div></div>
    </div>
    {% endif %}


    {% if show_hr %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm bg-primary text-white overflow-hidden">
                <div class="card-body p-4 d-flex justify-content-between align-items-center position-relative">
                    <div style="z-index: 1;">
                        <h2 class="fw-bold mb-1">üè¢ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏£‡∏±‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• (HR)</h2>
                        <div class="mt-2">
                            {% if current_emp_id %}
                                <a href="{% url 'employee_detail' current_emp_id %}" class="btn btn-warning btn-sm text-dark fw-bold rounded-pill shadow-sm btn-profile-link border-2 border-white">
                                    <i class="fas fa-id-card me-1"></i> {{ role_name }} (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß)
                                </a>
                            {% else %}
                                <span class="badge bg-warning text-dark">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: {{ role_name }}</span>
                            {% endif %}
                        </div>
                    </div>
                    <a href="/admin/" target="_blank" class="btn btn-light text-primary fw-bold px-4 py-2 rounded-pill shadow" style="z-index: 1;">
                        <i class="fas fa-cogs me-1"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Admin)
                    </a>
                    <i class="fas fa-users position-absolute text-white" style="font-size: 150px; opacity: 0.15; right: -20px; top: -30px;"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-md-3"><div class="card bg-white border-start border-4 border-primary shadow-sm h-100 py-2"><div class="card-body"><div class="text-xs font-weight-bold text-primary text-uppercase mb-1">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div><div class="h3 mb-0 fw-bold text-gray-800">{{ total_employees }} ‡∏Ñ‡∏ô</div></div></div></div>
        <div class="col-md-3"><div class="card bg-white border-start border-4 border-success shadow-sm h-100 py-2"><div class="card-body"><div class="text-xs font-weight-bold text-success text-uppercase mb-1">‡∏á‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div><div class="h3 mb-0 fw-bold text-gray-800">‡∏ø{{ total_salary }}</div></div></div></div>
        <div class="col-md-3"><div class="card bg-white border-start border-4 border-warning shadow-sm h-100 py-2"><div class="card-body"><div class="text-xs font-weight-bold text-warning text-uppercase mb-1">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏•‡∏≤</div><div class="h3 mb-0 fw-bold text-gray-800">{{ pending_leaves }} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>{% if pending_leaves > 0 %}<a href="{% url 'leave_approval' %}" class="stretched-link"></a>{% endif %}</div></div></div>
        <div class="col-md-3"><div class="card bg-white border-start border-4 border-danger shadow-sm h-100 py-2"><div class="card-body"><div class="text-xs font-weight-bold text-danger text-uppercase mb-1">‡∏Ç‡∏≤‡∏î/‡∏•‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏≤</div><div class="h3 mb-0 fw-bold text-gray-800">{{ absent_today }} ‡∏Ñ‡∏ô</div></div></div></div>
    </div>
    {% endif %}


    <div class="row">
        <div class="col-lg-8 mb-4">
            {% if show_hr %}
            <div class="card shadow mb-4">
                <div class="card-header py-3"><h6 class="m-0 font-weight-bold text-primary">üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏°‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (7 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)</h6></div>
                <div class="card-body"><div class="chart-bar" style="height: 300px;"><canvas id="myBarChart"></canvas></div></div>
            </div>
            <div class="card shadow mb-4">
                <div class="card-header py-3"><h6 class="m-0 font-weight-bold text-info">üè¢ ‡∏á‡∏ö‡πÅ‡∏¢‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å</h6></div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-light"><tr><th class="ps-4">‡πÅ‡∏ú‡∏ô‡∏Å</th><th class="text-center">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô</th><th class="text-end pe-4">‡∏£‡∏ß‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</th></tr></thead>
                            <tbody>
                                {% for dept in dept_summary %}
                                <tr>
                                    <td class="ps-4"><a href="{% url 'department_detail' dept.department %}" class="fw-bold text-primary">{{ dept.department }}</a></td>
                                    <td class="text-center"><span class="badge bg-light text-dark border px-3">{{ dept.count }}</span></td>
                                    <td class="text-end pe-4 fw-bold text-success">‡∏ø{{ dept.total_salary|intcomma }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% endif %}

            {% if show_sales %}
            <div class="card shadow">
                <div class="card-header py-3"><h6 class="m-0 font-weight-bold text-success">üìà ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</h6></div>
                <div class="card-body"><div style="height: 300px;"><canvas id="salesChart"></canvas></div></div>
            </div>
            {% endif %}
        </div>

        <div class="col-lg-4 mb-4">
            {% if show_hr %}
            <div class="card shadow mb-4">
                <div class="card-header py-3"><h6 class="m-0 font-weight-bold text-primary">‚è∞ ‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô</h6></div>
                <div class="card-body">
                    <div class="chart-pie pt-4 pb-2" style="height: 250px;"><canvas id="myPieChart"></canvas></div>
                    <div class="mt-4 text-center small"><span class="me-2"><i class="fas fa-circle text-success"></i> ‡∏õ‡∏Å‡∏ï‡∏¥</span><span class="me-2"><i class="fas fa-circle text-warning"></i> ‡∏™‡∏≤‡∏¢</span><span class="me-2"><i class="fas fa-circle text-danger"></i> ‡∏Ç‡∏≤‡∏î</span></div>
                </div>
            </div>
            {% endif %}

            {% if show_sales %}
            <div class="card bg-gradient-success text-white shadow mb-4" style="background: linear-gradient(45deg, #1cc88a, #13855c);">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div><h6 class="opacity-75">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏° (‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤)</h6><h1 class="fw-bold mb-0">‡∏ø{{ period_sales_amount }}</h1></div>
                    <i class="fas fa-coins fa-3x opacity-50"></i>
                </div>
            </div>
            <div class="card shadow mb-4">
                <div class="card-header py-3"><h6 class="m-0 font-weight-bold text-info">üèÜ ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏î‡∏µ Top 5</h6></div>
                <div class="card-body"><div style="height: 300px;"><canvas id="prodChart"></canvas></div></div>
            </div>
            {% endif %}

            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex justify-content-between align-items-center"><h6 class="m-0 font-weight-bold text-secondary">üîî ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h6><span class="badge bg-secondary rounded-pill">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</span></div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush" style="max-height: 400px; overflow-y: auto;">
                        {% for act in activities %}
                        <div class="list-group-item px-3 py-3 border-bottom">
                            <div class="d-flex w-100">
                                <div class="me-3"><div class="rounded-circle {{ act.bg }} d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;"><i class="fas {{ act.icon }} {{ act.color }}"></i></div></div>
                                <div class="flex-grow-1">
                                    <div class="d-flex justify-content-between align-items-start"><h6 class="mb-0 text-dark" style="font-size: 0.9rem;">{{ act.title }}</h6><small class="text-primary fw-bold ms-2">{{ act.time_show }}</small></div>
                                    <small class="text-muted d-block mt-1">{{ act.detail }}</small>
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="text-center py-5 text-muted opacity-50"><i class="fas fa-history fa-2x mb-2"></i><br>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://npmcdn.com/flatpickr/dist/l10n/th.js"></script> 

<script>
    document.addEventListener("DOMContentLoaded", function() {
        document.querySelectorAll(".datepicker").forEach(function(input) {
            flatpickr(input, { dateFormat: "Y-m-d", altInput: true, altFormat: "d/m/Y", locale: "th", defaultDate: input.getAttribute("value") });
        });
    });

    {% if show_hr %}
    new Chart(document.getElementById("myBarChart"), { type: 'bar', data: { labels: JSON.parse('{{ bar_labels|safe }}'), datasets: [{ label: "‡∏Ñ‡∏ô‡∏°‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô", backgroundColor: "#4e73df", hoverBackgroundColor: "#2e59d9", data: JSON.parse('{{ bar_data|safe }}') }] }, options: { maintainAspectRatio: false, scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } } });
    new Chart(document.getElementById("myPieChart"), { type: 'doughnut', data: { labels: ["‡∏õ‡∏Å‡∏ï‡∏¥", "‡∏™‡∏≤‡∏¢", "‡∏Ç‡∏≤‡∏î"], datasets: [{ data: JSON.parse('{{ pie_data|safe }}'), backgroundColor: ['#1cc88a', '#f6c23e', '#e74a3b'] }] }, options: { maintainAspectRatio: false, cutout: '70%', plugins: { legend: { display: false } } } });
    {% endif %}

    {% if show_sales %}
    new Chart(document.getElementById("salesChart"), { type: 'line', data: { labels: JSON.parse('{{ sales_labels|safe }}'), datasets: [{ label: "‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ (‡∏ö‡∏≤‡∏ó)", borderColor: "#1cc88a", backgroundColor: "rgba(28, 200, 138, 0.1)", fill: true, data: JSON.parse('{{ sales_chart_data|safe }}') }] }, options: { maintainAspectRatio: false, scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } } });
    new Chart(document.getElementById("prodChart"), { type: 'doughnut', data: { labels: JSON.parse('{{ top_prod_labels|safe }}'), datasets: [{ data: JSON.parse('{{ top_prod_data|safe }}'), backgroundColor: ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b'] }] }, options: { maintainAspectRatio: false, cutout: '60%', plugins: { legend: { position: 'bottom' } } } });
    {% endif %}
</script>
{% endblock %}